Для определения MAC-адреса назначения устройство использует протокол разрешения адресов (ARP). Протокол ARP выполняет две основные функции:

- Сопоставление IPv4-адресов и МАС-адресов;

- Сохранение таблицы сопоставлений.

Когда пакет отправляется на канальный уровень для инкапсуляции в кадре Ethernet, устройство обращается к таблице в своей памяти, чтобы найти MAC-адрес, который сопоставлен с IPv4-адресом. Эта таблица называется таблицей ARP или кэшем ARP. Таблица ARP хранится в оперативной памяти устройства.

Передающее устройство ищет в своей таблице ARP IPv4-адрес назначения и соответствующий MAC-адрес.

- Если IPv4-адрес назначения пакета находится в той же сети, что и IPv4-адрес источника, устройство ищет в таблице ARP IPv4-адрес назначения.

- Если IPv4-адрес назначения пакета находится не в той же сети, что IPv4-адрес источника, устройство ищет в таблице ARP IPv4-адрес шлюза по умолчанию.

В обоих случаях необходимо найти IPv4-адрес и соответствующий MAC-адрес устройства.

Каждая запись или строка в таблице ARP связывает IPv4-адрес с MAC-адресом. Отношение между двумя значениями называется сопоставлением. Это значит, что IPv4-адрес можно найти в таблице и с его помощью определить соответствующий MAC-адрес. Таблица ARP временно сохраняет (кэширует) сопоставление устройств в локальной сети (LAN).

Если устройство находит IPv4-адрес, то в качестве MAC-адреса в кадре используется соответствующий MAC-адрес. Если запись не найдена, устройство отправляет ARP-запрос.

Сообщения ARP-запроса инкапсулируются непосредственно в кадре Ethernet. Заголовок IPv4 отсутствует. В сообщении ARP-запроса содержится следующее:

- IPv4-адрес назначения: это IPv4-адрес, для которого требуется определить соответствующий MAC-адрес.

- MAC-адрес назначения: это неизвестный MAC-адрес, который в сообщении запроса ARP отсутствует.

ARP-запрос инкапсулируется в кадре Ethernet со следующей информацией в заголовке:

- MAC-адрес назначения: широковещательный адрес, требующей принятия и обработки ARP-запроса всеми сетевыми платами Ethernet в локальной сети (LAN).

- MAC-адрес источника: это отправитель MAC-адреса в ARP-запросе.

- Тип: в сообщении ARP-запроса есть поле «Тип» со значением 0x806. Оно информирует принимающую сетевую плату о том, что для части кадра, выделенной для данных, необходимо использовать процесс ARP.

В сообщении ARP-ответа содержится следующее:

- IPv4-адрес отправителя: это IPv4-адрес отправителя, т. е. устройства, чей MAC-адрес был запрошен.

- MAC-адрес отправителя: это MAC-адрес отправителя, т. е. MAC-адрес, который был запрошен отправителем в ARP-запросе.

ARP-ответ инкапсулируется в кадре Ethernet со следующей информацией в заголовке:

- MAC-адрес назначения: это MAC-адрес отправителя ARP-запроса.

- MAC-адрес источника: это отправитель MAC-адреса в ARP-ответе.

- Тип: в сообщении ARP-запроса есть поле «Тип» со значением 0x806. Оно информирует принимающую сетевую плату о том, что для части кадра, выделенной для данных, необходимо использовать процесс ARP.

В каждом устройстве есть таймер кэша ARP, который удаляет записи из таблицы ARP, не используемые в течение указанного периода времени. Этот период может быть разным в зависимости от операционной системы устройства. Например, некоторые операционные системы Windows хранят записи кэша ARP в течение 2 минут, как показано на рисунке.

Кроме того, можно использовать некоторые команды, чтобы вручную удалить все или некоторые записи из таблицы ARP. После удаления записи процесс отправки ARP-запроса и получения ARP-ответа необходимо задействовать повторно, чтобы зарегистрировать сопоставление в таблице ARP.

Проблемы ARP:

- Широковещательные рассылки ARP. Поскольку ARP-запрос является кадром широковещательной рассылки, его получают и обрабатывают все устройства в локальной сети. В стандартной корпоративной сети такие широковещательные рассылки, скорее всего, не окажут серьезного влияния на производительность сети. Но если в сети много устройств и все они одновременно попытаются получить доступ к сетевым службам, это может на короткий период времени негативно повлиять на работу сети, как показано на рисунке. После того как устройства разошлют начальные запросы широковещательной рассылки ARP и получат необходимые MAC-адреса, любое влияние на сеть будет сведено к минимуму.

- Спуфинг с помощью протокола разрешения адресов (ARP). В некоторых случаях использование протокола разрешения адресов (ARP) может представлять определенный риск для безопасности. Такие атаки получили название ARP-спуфинг или «отравление» ARP-кэша. В ходе таких атак злоумышленник отправляет ответ на ARP-запрос IPv4-адреса с адресом другого устройства, например, шлюза по умолчанию, как показано на рисунке. Злоумышленник отправляет ARP-ответ со своим MAC-адресом. Получатель ARP-ответа добавит фальсифицированный MAC-адрес в свою таблицу ARP, что позволит злоумышленнику получать отправляемые пакеты.